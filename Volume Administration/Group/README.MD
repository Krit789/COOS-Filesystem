# Volume Group Administration

Volume Group (VG) เป็นกลุ่มของ Physical Volumes (PVs) ที่ถูกรวมกันเพื่อสร้างพื้นที่จัดเก็บข้อมูลในรูปแบบของ Logical Volumes (LVs) ในระบบ LVM

> [!NOTE]
> ภายใน Volume Group (VG) มีพื้นที่ว่างที่สามารถจัดสรรได้จะถูกแบ่งเป็น units ที่มีขนาดคงที่ที่เรียกว่า `extents`

การใช้ extents ใน LVM ช่วยให้ผู้ใช้สามารถจัดการพื้นที่จัดเก็บข้อมูลใน Volume Group (VG) ได้อย่างยืดหยุ่นและมีประสิทธิภาพ

---
## การสร้างVolume Group

หากต้องการสร้าง Volume Group จาก Physical Volumes ให้ใช้คำสั่ง

```
vgcreate <volume_group_name> <physical_volume> [<physical_volume> ...]
```

**ตัวอย่างการใช้งาน:**

* สร้าง Volume Group ชื่อ "myvg" โดยใช้สอง Physical Volumes **/dev/sdb1** และ **/dev/sdc1** โดยใช้คำสั่ง

    `vgcreate myvg /dev/sdb1 /dev/sdc1`

* สามารถตรวจสอบว่า Volume Group ถูกสร้างเรียบร้อยด้วยคำสั่ง

    `vgdisplay myvg`

เมื่อใช้ Physical Volumes ในการสร้างแล้ว พื้นที่ดิสก์จะถูกแบ่งออกเป็น 4MB extents ตามค่าเริ่มต้น 

> [!NOTE]
> โดย extent นี้คือจำนวนขั้นต่ำที่ Logical Volume อาจเพิ่มหรือลดขนาดได้ 
ในส่วนขยายจำนวนมากจะไม่มีผลกระทบต่อประสิทธิภาพ I/O ของโลจิคัลวอลุ่ม

>[!TIP]
>- สามารถระบุขนาดขอบเขตด้วย option `-s` ให้กับคำสั่ง vgcreate หากขนาด default extent ไม่เหมาะสม 
>- สามารถกำหนดขีดจำกัดจำนวน physical หรือ logical volumes, the volume group ได้โดยใช้ option `-p` และ `-l` 


Volume group จะจัดสรร physical extents ตามกฎทั่วไป เช่น ไม่วางแถบขนาน (parallel stripes) บนวอลุ่มฟิสิคัลเดียวกัน นี่คือ นโยบายการจัดสรรพื้นที่แบบปกติ (normal allocation policy)

ใช้ตัวเลือก `--alloc` ของคำสั่ง `vgcreate` เพื่อระบุ นโยบายการจัดสรรพื้นที่  ซึ่งอาจจะเป็น `contiguous`, `anywhere`, หรือ `cling` โดยทั่วไปแล้ว ไม่จำเป็นต้องใช้นโยบายการจัดสรรพื้นที่อื่นนอกเหนือจาก `normal`   ยกเว้นกรณีพิเศษที่คุณต้องการกำหนดการจัดสรรพื้นที่ที่ไม่ปกติ

>[!TIP]
> - **Physical Extents** : เป็นหน่วยพื้นฐานที่เล็กที่สุดของพื้นที่เก็บข้อมูลที่ LVM สามารถจัดสรรได้
>- **Parallel Stripes** : คือการแบ่งข้อมูลออกเป็นส่วนๆ แล้วกระจายไปยังวอลุ่มฟิสิคัลหลายๆ วอลุ่มเพื่อเพิ่มประสิทธิภาพการอ่าน/เขียน
>- **Contiguous Allocation** : จัดสรรพื้นที่ฟิสิคัลติดกันสำหรับ Logical Volume
>- **Anywhere Allocation** : จัดสรรพื้นที่ฟิสิคัลไม่ติดกันจากวอลุ่มฟิสิคัลใดก็ได้ในกลุ่มวอลุ่ม 
>- **Cling Allocation** : ขยาย Logical Volume โดยจัดสรรพื้นที่ฟิสิคัลจากวอลุ่มฟิสิคัลเดียวกันที่ใช้จัดสรรพื้นที่ไปแล้ว

LVM volume groups และ Logical Volume จะรวมอยู่ในไดเร็กทอรีไฟล์พิเศษของอุปกรณ์ในไดเร็กทอรี `/dev` โดยมีเค้าโครงดังนี้:

-   `/dev/mapper` : ไดเร็กทอรีนี้เก็บลิงก์เชิงสัญลักษณ์ที่แสดง Logical Volume (LVs) ซึ่งเป็นพาร์ติชั่นเสมือนที่ LVM จัดการ โดยทั่วไปชื่อของลิงก์เหล่านี้จะขึ้นต้นด้วย `lv` และผู้ใช้กำหนดเอง (เช่น lv01, lv_data, lv_root)
- `/dev/lvm` : ไดเร็กทอรีนี้ประกอบด้วยโหนดตัว map อุปกรณ์ ซึ่งให้ข้อมูลเกี่ยวกับคุณสมบัติหรือส่วนประกอบ LVM เฉพาะ ตัวอย่างเช่น:
   * `pvlist` : แสดงรายละเอียดเกี่ยวกับ Physical Volume (PVs) ซึ่งเป็นพาร์ติชั่นดิสก์หรืออุปกรณ์ที่ประกอบกันเป็นกลุ่มวอลุ่ม
   * `vglist` : แสดงข้อมูลเกี่ยวกับ Volume Group (VGs) ซึ่งเป็นชุดของ PVs ที่จัดกลุ่มเพื่อการจัดการพื้นที่เก็บข้อมูลแบบรวมศูนย์
   * `lvchange` : อนุญาตให้แก้ไขคุณสมบัติของ Logical Volume หลังจากสร้าง

   ![Image](https://miro.medium.com/v2/resize:fit:1342/format:webp/0*aVQTBvKe8oocgmsd.png)
   รูปจาก: [https://medium.com/@nareerat.prr/what-is-lvm-24ae24322eff](https://medium.com/@nareerat.prr/what-is-lvm-24ae24322eff)

---
## สร้าง Volume Groups ใน Cluster

สร้าง Volume Group ในสภาพแวดล้อมที่มีคอมพิวเตอร์หลายเครื่องทำงานร่วมกัน (Cluster) ซึ่งแตกต่างจากการสร้างบนคอมพิวเตอร์เครื่องเดียว (Single Node)

จุดประสงค์:
- **เพิ่มพื้นที่จัดเก็บข้อมูล**: การรวมพื้นที่จัดเก็บข้อมูลจากหลายโหนดในคลัสเตอร์เข้าด้วยกัน เพิ่มพื้นที่โดยรวมที่สามารถใช้งานได้
- **เพิ่มความพร้อมใช้งาน**: หากโหนดใดเกิดขัดข้อง โหนดอื่นๆ ยังสามารถเข้าถึงข้อมูลได้ เนื่องจากกลุ่มวอลุ่มถูกแชร์ระหว่างโหนดต่างๆ
- **เพิ่มประสิทธิภาพ**: การกระจายการอ่านเขียนข้อมูลไปยังหลายโหนด ช่วยเพิ่มความเร็วในการเข้าถึงข้อมูล

สามารถสร้าง CLVM volume groups ใน cluster environment ได้ด้วยคำสั่ง `vgcreate` เช่นเดียวกับที่สร้างบนโหนด

**การสร้างและจัดการ Volume Groups ใน Cluster**

- **Volume Groups ที่แชร์ระหว่างสมาชิกใน Cluster** : ควรสร้างด้วยการตั้งค่าแอตทริบิวต์แบบคลัสเตอร์ (clustered attribute) โดยใช้คำสั่ง `vgcreate -cy` หรือ `vgchange -cy` แอตทริบิวต์นี้จะถูกตั้งค่าโดยอัตโนมัติหาก CLVMD (Clustered Logical Volume Manager Daemon) กำลังทำงานอยู่ แอตทริบิวต์แบบ Cluster จะส่งสัญญาณว่า Volume Groups นี้ควรได้รับการจัดการและป้องกันโดย CLVMD
- **Volume Groups ที่ไม่ได้แชร์ใน Cluster** : ควรปิดการใช้งานแอตทริบิวต์แบบคลัสเตอร์ด้วยคำสั่ง `vgcreate -cn` หรือ `vgchange -cn` เพื่อให้ Volume Groups นี้มองเห็นได้เฉพาะบนโฮสต์เดียวเท่านั้น

Volume Groups ที่สร้างด้วยแอตทริบิวต์แบบคลัสเตอร์บนพื้นที่จัดเก็บข้อมูลแบบแชร์จะสามารถมองเห็นได้บนคอมพิวเตอร์ทุกเครื่องในคลัสเตอร์ที่สามารถเข้าถึงพื้นที่จัดเก็บข้อมูลนั้นร่วมกันได้

สามารถกำหนดให้ Volume Groups เป็นแบบ local ซึ่งมองเห็นได้เฉพาะบนโหนดเดียวใน cluster ได้ โดยการใช้ตัวเลือก `-cn` ในคำสั่ง `vgcreate`

**ตัวอย่างการใช้งาน:**

สร้าง Volume Groups ที่จำกัด (local) เฉพาะโหนดที่ทำงานคำสั่ง 
```
vgcreate -cn vg1 /dev/sdd1 /dev/sde1
```
คำสั่งนี้สร้าง Volume Groups ชื่อ vg1 ที่ประกอบด้วย Physical Volumes /dev/sdd1 และ /dev/sde1

#### การปรับ Volume Groups ให้เป็น Local หรือ Clustered:
- สามารถใช้คำสั่ง `vgchange` พร้อมกับตัวเลือก `-c` เพื่อเปลี่ยนลักษณะของ Volume Groups ที่มีอยู่ ให้เป็นแบบ local หรือแบบ clustered 
#### การตรวจสอบกลุ่มวอลุ่มที่เป็นแบบ Clustered:
- ใช้คำสั่ง `vgs` เพื่อตรวจสอบว่ากลุ่มวอลุ่มที่มีอยู่เป็นกลุ่มวอลุ่มแบบคลัสเตอร์หรือไม่ คำสั่งนี้จะแสดงแอตทริบิวต์ 'c' หากกลุ่มวอลุ่มนั้นเป็นแบบคลัสเตอร์ ตัวอย่างเช่น
```
# vgs
  VG            #PV #LV #SN Attr   VSize  VFree
  VolGroup00      1   2   0 wz--n- 19.88G    0
  testvg1         1   1   0 wz--nc 46.00G 8.00M
```

ในตัวอย่างนี้ VolGroup00 ไม่ใช่ Volume Groups แบบ Cluster (ไม่มีแอตทริบิวต์ 'c') ในขณะที่ testvg1 เป็น Volume Groups แบบ Cluster (สังเกตแอตทริบิวต์ 'c' ใต้หัวข้อ Attr)

---
## การเพิ่ม  Physical Volumes ให้กับกลุ่ม Volume Group
ใช้คำสั่ง `vgextend` เพื่อเพิ่ม Physical Volumes เพิ่มเติมให้กับ Volume Group ที่มีอยู่คำสั่งนี้จะช่วยขยายความจุของ Volume Group โดยเพิ่ม Physical Volumes ที่ว่างอยู่หนึ่งหรือมากกว่า

```
vgextend <volume_group_name> <physical_volume>
```

ตัวอย่างการใช้งาน:
- `vgextend vg1 /dev/sdf1`/dev/sdf1 จะถูกเพิ่มเข้าไปในกลุ่มวอลุ่ม vg1 ส่งผลให้ความจุรวมของกลุ่มวอลุ่มเพิ่มขึ้น

---
## Volume Groups

คุณสมบัติของ Volume Groups แสดงออกมาได้ในสองคำสั่งคือ `vgs` และ `vgdisplay`

- `vgscan` : คำสั่งนี้ใช้สำหรับสแกนดิสก์ทั้งหมดเพื่อค้นหา Volume Group และสร้างไฟล์แคช LVM ขึ้นใหม่ นอกจากนี้ยังแสดงรายการ Volume Group ที่พบ
- `vgs` : คำสั่งนี้ใช้แสดงรายละเอียดของ Volume Group ทั้งหมดในรูปแบบตารางที่ปรับแต่งได้ เหมาะสำหรับการดูภาพรวมหรือใช้ในสคริปต์
- `vgdisplay` : คำสั่งนี้ใช้แสดงรายละเอียดเชิงลึกของ Volume Group ที่ระบุ เหมาะสำหรับการตรวจสอบข้อมูลและแก้ไขปัญหา

```
# vgdisplay new_vg
  --- Volume group ---
  VG Name               new_vg
  System ID
  Format                lvm2
  Metadata Areas        3
  Metadata Sequence No  11
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                1
  Open LV               0
  Max PV                0
  Cur PV                3
  Act PV                3
  VG Size               51.42 GB
  PE Size               4.00 MB
  Total PE              13164
  Alloc PE / Size       13 / 52.00 MB
  Free  PE / Size       13151 / 51.37 GB
  VG UUID               jxQJ0a-ZKk0-OpMO-0118-nlwO-wwqd-fD5D32
```

---
## สแกน Disk สำหรับ Volume Group เพื่อสร้าง Cache File

- **สแกนอุปกรณ์ดิสก์ทั้งหมดที่รองรับ** : เมื่อรันคำสั่ง `vgscan` มันจะตรวจสอบทุกอุปกรณ์ดิสก์ที่ระบบสามารถมองเห็น โดยเฉพาะอย่างยิ่งเพื่อค้นหาอุปกรณ์ที่ถูกกำหนดค่าเป็น LVM physical volumes (PVs) และ LVM volume groups (VGs)

- **สร้างและอัปเดต LVM Cache File** : ข้อมูลที่พบจากการสแกนจะถูกใช้ในการสร้างหรืออัปเดตไฟล์แคช LVM ซึ่งตั้งอยู่ที่ `/etc/lvm/cache/.cache` ไฟล์นี้ทำหน้าที่เก็บรายการของอุปกรณ์ LVM ที่พบล่าสุด ช่วยให้ LVM ทำงานได้รวดเร็วขึ้นโดยไม่ต้องสแกนดิสก์ทั้งหมดทุกครั้ง
- **รันอัตโนมัติและด้วยตนเอง** : คำสั่ง `vgscan` มักจะรันโดยอัตโนมัติในบางสถานการณ์ เช่น ตอนเริ่มระบบ หลังจากสร้างหรือลบ VGs/PVs หรือเมื่อ LVM ตรวจพบความไม่สอดคล้อง นอกจากนี้ คุณยังสามารถเรียกใช้คำสั่งนี้ด้วยตนเองเมื่อต้องการอัปเดตแคช LVM เอง

vgscan เป็นคำสั่งสำคัญที่ช่วยให้ LVM ติดตามและจัดการกับอุปกรณ์ดิสก์ที่เกี่ยวข้องอย่างมีประสิทธิภาพ

> [!NOTE]
> โดย extent นี้คือจำนวนขั้นต่ำที่ Logical Volume อาจเพิ่มหรือลดขนาดได้ 
ในส่วนขยายจำนวนมากจะไม่มีผลกระทบต่อประสิทธิภาพ I/O ของโลจิคัลวอลุ่ม